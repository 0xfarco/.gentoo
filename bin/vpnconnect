#!/bin/bash

CONFIG_DIR="/home/farco/Public/vpn-configs"
CRED_FILE="/home/farco/.cred"
TMP_CONFIG="/tmp/vpnconnecttemp.ovpn"
DMENU="dmenu -i -p"

if [[ ! -f "$CRED_FILE" ]]; then
  notify-send "VPN" "Credentials file $CRED_FILE not found"
  exit 1
fi

if [[ ! -d "$CONFIG_DIR" ]]; then
  notify-send "VPN" "Config directory $CONFIG_DIR not found"
  exit 1
fi

updateicon() {
	echo "$1" > /tmp/vpnconnecticon
}

closevpn() {
  vpnpid="$(cat /tmp/vpnconnectpid)"
  kill -15 "$vpnpid"
  rm -f /tmp/vpnconnectpid
  updateicon "D"
  notify-send "VPN" "VPN connection terminated."
}

startvpn() {
  local configs=("$CONFIG_DIR"/*.ovpn)
  if [[ ${#configs[@]} -eq 0 ]]; then
    notify-send "VPN" "No .ovpn configs found in $CONFIG_DIR"
    exit 1
  fi
  local options=""
  for f in "${configs[@]}"; do
    options+=$(basename "$f")$'\n'
  done
  local choice=$(echo -e "$options" | $DMENU "Select VPN config:")
  if [[ -z "$choice" ]]; then
    notify-send "VPN" "No selection made, exiting."
    exit 1
  fi
  for f in "${configs[@]}"; do
    [[ $(basename "$f") == "$choice" ]] && OVPN_FILE="$f"
  done
  sed "/^auth-user-pass/d" "$OVPN_FILE" > "$TMP_CONFIG"
  echo "auth-user-pass $CRED_FILE" >> "$TMP_CONFIG"
  echo "auth-nocache" >> "$TMP_CONFIG"

  sudo -A openvpn --config "$TMP_CONFIG" &
  echo $! > /tmp/vpnconnectpid
  sleep 5
  updateicon "C"
  notify-send "VPN" "VPN connection started."
}


askconnection() {
	choice=$(printf "Connect" | $DMENU "Select option:")
	case "$choice" in
		Connect) startvpn;;
	esac
}

asktoend() {
	response=$(printf "No\\nYes" | $DMENU "VPN is active. End connection?") &&
	[ "$response" = "Yes" ] &&  closevpn
}

case "$1" in
	startvpn) startvpn;;
	kill) closevpn;;
	*) ([ -f /tmp/vpnconnectpid ] && asktoend && exit) || askconnection;;
esac
